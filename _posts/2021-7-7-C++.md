---
layout: post
title: C++
categories: S11
---

> From [The Cherno](https://www.youtube.com/channel/UCQ-W1KE9EYfdxhL6S4twUNw) C++

### 描述

高性能 直接控制硬件指令 从稀有架构到广泛系统支持  
C++直接编译成当前CPU机器码 仅依赖对应编译器

Java、C# 是编译器译为中间语言 并运行在虚拟机隔离层 在运行时通过虚拟机输出对应机器码 因此无需重写编译工程 而仅需改进运行时虚拟机 将平台依赖性从编译阶段降低至最终运行时机器码

虚拟机优化后的机器码 优于低效C++生产的机器码 所以正确的C++应当是高性能的 所以如何正确写C++很重要 理解C++如何工作是正确书写C++代码的关键

### 环境结构

**Machine** Intel/AMD/Nvidia x64/x86/ARM/MIPS  
**System** Windows 10  
**Environment** (Compiler)Visual Studio 2017  
**Module** Visual Assist / Desktop Development with C++ / (C#).NET desktop Development  
**Configuration** ChernoVS.vssettings / (Avoid Spaces)Project Path C:\Dev\CPP\
**Solution** 多个相关 Project  
**Project** 多组相关文件 引用、外部依赖、头文件、源文件、资源文件  
**Binary** 文件可编译成多种二进制 如库、可执行  
**解决方案配置** 一组生成 **Project** 以及编译的规则  
**Projec属性** 用于修改各 **解决方案配置** 的属性

### 语言结构

#### 预处理 Pre-process

```
#include <iostream>

#if 0
some code
#endif
```

编译器编译前 首先预处理所有以 **#** 开头的预处理语句  

**#include** 寻找文件 复制其内容至此语句处并替换  
**iostream** 包含5000多行代码 其本身亦包含 **#include** 滚雪球一般 因此一个 Ttranslation unit 对应的 Object file 都很大

**#if #endif** 根据给出条件决定是否包含或不包含某段代码  
预处理语句不涉及编译或运行代码 编译前对代码文本做出处理 属于对文本编程  

**Projec属性**  
**Optimization** Maximize Speed  
**preprocessor** Preprocess to a file (yes/on)  
可将编译阶段前 预处理后的文件(.i) 显式单独输出(此时不输出目标文件)  

Output Files Assembler Output Assembly-Only Listing(.asm)

```
int Mt(int a, int b)
{
	int result = a * b;
	return result;
}
```

```
; Line 3
	mov	eax, DWORD PTR _a$[ebp]
	imul	eax, DWORD PTR _b$[ebp]
	mov	DWORD PTR _result$[ebp], eax
; Line 4
	mov	eax, DWORD PTR _result$[ebp] // 非优化代码 Slow code
```

```
int Mt(int a, int b)
{
	return a * b;
}
```

```
; Line 3
	mov	eax, DWORD PTR _a$[ebp]
	imul	eax, DWORD PTR _b$[ebp] // eax保存结果
```

Optimization Maximize Speed  
O2 / RTC ERROR
Code Generation Basic Runtime Check Default(won't perform runtime checks code the compiler will insert to help us with debugging at runtime(编译后在运行时检查) )

```
int Mt()
{
	return 5 * 2;
}
```

```
; Line 3
	mov	eax, 10					; 0000000aH
```
Constant folding  
constant that can be worked out at compile time
No nedd two constant values at runtime

```
const char* Log(const char* message)
{
	return message;
}

int Mt(int a, int b)
{
	Log("Multiply");
	return a * b;
}
```
```
?Mt@@YAHHH@Z PROC					; Mt, COMDAT
; File c:\dev\cpp\helloworld\helloworld\math.cpp
; Line 8
	push	ebp
	mov	ebp, esp
	sub	esp, 64					; 00000040H
	push	ebx
	push	esi
	push	edi
	mov	ecx, OFFSET __8998EEE5_math@cpp
	call	@__CheckForDebuggerJustMyCode@4
; Line 9
	push	OFFSET ??_C@_08EOBDLMOI@Multiply@
	call	?Log@@YAPBDPBD@Z			; Log // generate a call instruction
	add	esp, 4
; Line 10
	mov	eax, DWORD PTR _a$[ebp]
	imul	eax, DWORD PTR _b$[ebp]
; Line 11
	pop	edi
	pop	esi
	pop	ebx
	mov	esp, ebp
	pop	ebp
	ret	0
?Mt@@YAHHH@Z ENDP					; Mt

?Log@@YAPBDPBD@Z PROC					; Log, COMDAT
; File c:\dev\cpp\helloworld\helloworld\math.cpp
; Line 2
	push	ebp
	mov	ebp, esp
	sub	esp, 64					; 00000040H
	push	ebx
	push	esi
	push	edi
	mov	ecx, OFFSET __8998EEE5_math@cpp
	call	@__CheckForDebuggerJustMyCode@4
; Line 3
	mov	eax, DWORD PTR _message$[ebp] // just return valve
; Line 4
	pop	edi
	pop	esi
	pop	ebx
	mov	esp, ebp
	pop	ebp
	ret	0
?Log@@YAPBDPBD@Z ENDP					; Log
```
?Log@@YAPBDPBD@Z ?Mt@@YAHHH@Z fuction signature Tokenizing for linking multipe function in multiple OBJ to link together look up fuction signture

not storing the Log function return value  
it could be optimized 

```
?Mt@@YAHHH@Z PROC					; Mt, COMDAT
; File c:\dev\cpp\helloworld\helloworld\math.cpp
; Line 7
	push	ebp
	mov	ebp, esp
	mov	ecx, OFFSET __8998EEE5_math@cpp
	call	@__CheckForDebuggerJustMyCode@4
	mov	eax, DWORD PTR _a$[ebp]
	imul	eax, DWORD PTR _b$[ebp] // call instruction has been remove by compiler because does nothing
; Line 10
	pop	ebp
	ret	0
?Mt@@YAHHH@Z ENDP					; Mt
```

#### 主体 main

```
int main()
{ some code }
```

机器将先从 **main** 函数按行执行代码  
**main** 函数返回类型为整型 但 **main** 特例无返回值 不返回时默认返回 0

```
std::cout << "Hello World!" << std::endl;
std::cout.print("Hello World!").print(std::endl);
```

**<<** 运算符重载 运算符就是函数  
**<<** 和 cout **对象函数 print** 将字符串作为参数 实质相同  
**std::endl** 参数使控制台光标移至下一行